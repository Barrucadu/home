#!/bin/zsh

function usage()
{
    echo "Usage: c2flow SOURCE.c HEADER.h [OPTIONS]"
    echo "     Prints out a flowchart using cflow, and strips out all functions not defined in the header file."
    echo
    echo "     -c:  display how many times each function is used."
    echo "     -cc: display only how many times each function is used, no flowchart."
    exit
}

function printline()
{
    if [[ "$2" == "-cc" ]];
    then
        echo $1 | sed "s/(.*/()/" | sed "s/^\.//" >> /tmp/c2flow
    else
        echo $1 | sed "s/(.*/()/" | sed "s/^\.//" | tee -a /tmp/c2flow
    fi
 }

if [[ "$1" == "-h" ]];
then
    usage
fi

cflow --omit-arguments --omit-symbol-names $1 | awk '{print "." $0}'> /tmp/cflow
cat $2 > /tmp/c2flowhead
echo "main()" >> /tmp/c2flowhead
touch /tmp/c2flow
touch /tmp/c2flowfuncsc

while read line;
do
    cleanline="`echo $line | sed \"s/^\. *//\" | sed \"s/(.*/(/\"`"
    cleanlin2="`echo $line | sed \"s/^\. *//\" | sed \"s/(.*/ (/\"`"

    if grep $cleanline /tmp/c2flowhead &>/dev/null &>/dev/null;
    then
        printline $line $3
    fi

    if grep $cleanlin2 /tmp/c2flowhead &>/dev/null &>/dev/null;
    then
        printline $line $3
    fi
done < /tmp/cflow

if [[ "$3" == "-c" ]] || [[ "$3" == "-cc" ]];
then
    cat /tmp/c2flow | sed "s/ *//"  | sort | uniq > /tmp/c2flowfuncs
    echo "main(): 1"
    while read line;
    do
        count="`grep -c $line /tmp/c2flow`"
        echo "$line: $count"
    done < /tmp/c2flowfuncs
    rm /tmp/c2flowfuncs
fi

rm /tmp/cflow
rm /tmp/c2flow
