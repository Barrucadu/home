#!/bin/zsh

adjustment=0
end=0
verbose=0
mute=0
mpd=0
amixer get Master | grep % | sed "s/%\].*//" | sed "s/.* \[//" > /tmp/volume
volume=`cat /tmp/volume`

function usage()
{
    echo "$0 (up|down) [-v] [-vv] [-m] [-p]"
    echo "$0 (up|down) [--verbose] [--very-verbose] [--toggle-mute] [--toggle-mpd-play]"
    echo
    echo "All arguments are optional and can be in any order, except for 'up' or 'down' which are mandatory and must be the first argument."
    echo "     --verbose         Print the current volume and the final volume every iteration of the loop."
    echo "     --very-verbose    Print the output from amixer every iteration of the loop."
    echo "     --toggle-mute     Toggle mute on the master channel when the final volume is reached."
    echo "     --toggle-mpd-play Toggle play/pause on MPD when the final volume is reached."
    echo
    echo "By Michael Walker (Barrucadu)"

    exit
}

function checkargs()
{
    case $1 in
        -v)
            verbose=1
            ;;
        -vv)
            verbose=2
            ;;
        -m)
            mute=1
            ;;
        -p)
            mpd=1
            ;;
        --verbose)
            verbose=1
            ;;
        --very-verbose)
            verbose=2
            ;;
        --toggle-mute)
            mute=1
            ;;
        --toggle-mpd-play)
            mpd=1
            ;;
        *)
            usage
            ;;
    esac
}

function verbose()
{
    if [[ $verbose == 1 ]]; then
        $*
    else
        $* &>/dev/null
    fi
}

function veryverbose()
{
    if [[ $verbose == 2 ]]; then
        $*
    else
        $* &>/dev/null
    fi
}

case $1 in
    down)
        adjustment=1%-
        ;;
    up)
        adjustment=1%+
        end=100
        ;;
    *)
        usage
        ;;
esac

for arg in "${*[@]}"; do
    if [[ ! $arg == $1 ]]; then
        checkargs $arg
    fi
done

while [[ ! $volume == $end ]]; do
    veryverbose amixer set Master $adjustment

    amixer get Master | grep % | sed "s/%\].*//" | sed "s/.* \[//" &>/tmp/volume
    volume=`cat /tmp/volume`
    
    verbose echo "$volume : $end"

    sleep 0.05
done

if [[ $mute == 1 ]]; then
    veryverbose amixer set Master toggle
fi

if [[ $mpd == 1 ]]; then
    veryverbose mpc toggle
fi
