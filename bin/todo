#!/bin/zsh

flag=$1
arg=$2
todofile="/home/barrucadu/docs/main.todo"

function add()
{
    echo "* TODO [#B] $arg" >> $todofile
}

function delete()
{
    sed -i "${arg}d" $todofile
}

function toggle()
{
    sed -i "$arg s/^\* TODO/\* ODOT/"  $todofile
    sed -i "$arg s/^\* TODO/\* DONE/"  $todofile
    sed -i "$arg s/^\* ENODE/\* TODO/" $todofile
}

function priority()
{
    sed -i "$arg s/^\* TODO \[\#A\]/\* TODO [#D]/" $todofile
    sed -i "$arg s/^\* TODO \[\#B\]/\* TODO [#A]/" $todofile
    sed -i "$arg s/^\* TODO \[\#C\]/\* TODO [#B]/" $todofile
    sed -i "$arg s/^\* TODO \[\#D\]/\* TODO [#C]/" $todofile
}

function clear()
{
    sed -i "/^\* DONE .*$/d" $todofile
}

function list()
{
    grep -n -e "^\* \(TODO\|DONE\)" $todofile
}

function listtodo()
{
    grep -n "^\* TODO" $todofile
}

function listdone()
{
    grep -n "^\* DONE" $todofile
}

function help()
{
    echo "Usage: todo [flag] [arg]"
    echo
    echo "---"
    echo
    echo "A simple todo-file manager, which manipulates todo files in a subset of the Emacs Org-mode format."
    echo
    echo "---"
    echo
    echo "Flags:"
    echo "    a,   add      - Add new entry.                       arg = description."
    echo "    d,   delete   - Delete existing entries by regex.    arg = sed-compatible regular expression (including slashes)."
    echo "    t,   toggle   - Toggle entries' todo/done state.     arg = line number."
    echo "    p,   priority - Increment priority of entry.         arg = line number."
    echo "    c,   clear    - Clear finished entries from list."
    echo "    ls,  list     - List entries."
    echo "    lt, listtodo  - List entries marked as to do."
    echo "    ld, listdone  - List entries marked as done."
    echo "    h,   help     - Display this text."
    echo
}

case "$flag" in
    "a")
        add
        ;;
    "add")
        add
        ;;
    "d")
        delete
        ;;
    "delete")
        delete
        ;;
    "t")
        toggle
        ;;
    "toggle")
        toggle
        ;;
    "p")
        priority
        ;;
    "priority")
        priority
        ;;
    "c")
        clear
        ;;
    "clear")
        clear
        ;;
    "ls")
        list
        ;;
    "list")
        list
        ;;
    "lt")
        listtodo
        ;;
    "listtodo")
        listtodo
        ;;
    "ld")
        listdone
        ;;
    "listdone")
        listdone
        ;;
    "h")
        help
        ;;
    "help")
        help
        ;;
    "")
        help
        ;;
    *)
        echo "Error: unknown flag '$flag'."
        return 1
        ;;
esac

return 0
