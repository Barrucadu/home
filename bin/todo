#!/bin/zsh

flag=$1
arg=$2
todofile="/home/barrucadu/docs/main.todo"

function append()
{
    echo "* TODO $arg" >> $todofile
}

function delete()
{
    sed -i "$arg d" $todofile
}

function deleteregex()
{
    sed -i "/$arg/ d" $todofile
}

function toggle()
{
    sed -i "$arg s/^\* TODO/\* ODOT/" $todofile
    sed -i "$arg s/^\* DONE/\* ENODE/" $todofile
    sed -i "$arg s/^\* ENODE/\* TODO/" $todofile
    sed -i "$arg s/^\* ODOT/\* DONE/" $todofile
}

function clean()
{
    sed -i "/^\* DONE .*$/d" $todofile
}

function listall()
{
    grep -n -e "^\* \(TODO\|DONE\)" $todofile
}

function listtodo()
{
    grep -n "^\* TODO" $todofile
}

function listfinished()
{
    grep -n "^\* DONE" $todofile
}

function help()
{
    echo "Usage: todo [flag] [arg]"
    echo
    echo "---"
    echo
    echo "A simple todo-file manager, which manipulates todo files in a subset of the Emacs Org-mode format."
    echo
    echo "---"
    echo
    echo "Flags:"
    echo "    a  - Append new entry."
    echo "         arg = Description"
    echo
    echo "    d  - Delete existing entry."
    echo "         arg = Line number"
    echo
    echo "    dr - Delete existing entries by regex."
    echo "         arg = Sed-compatible regular expression."
    echo
    echo "    t  - Toggle an entry's todo/done state.."
    echo "         arg = Line number"
    echo
    echo "    c  - Clean finished entries from list."
    echo "    l  - List entries."
    echo "    lt - List entries marked as to do."
    echo "    lf - List entries marked as finished."
    echo "    h  - Display this text."
    echo
}

case "$flag" in
    "a")
        append
        ;;
    "d")
        delete
        ;;
    "dr")
        deleteregex
        ;;
    "t")
        toggle
        ;;
    "c")
        clean
        ;;
    "l")
        listall
        ;;
    "lt")
        listtodo
        ;;
    "lf")
        listfinished
        ;;
    "h")
        help
        ;;
    "")
        help
        ;;
    *)
        echo "Error: unknown flag '$flag'."
        return 1
        ;;
esac

return 0
