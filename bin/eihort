#!/bin/zsh

mhd=true
m2hd=false
archos5=false
media=true
share=true
torrents=true
www=true
up=true
pacsync=true

function parsearg()
{
    case $1 in
        "nomhd")
            mhd=false;;
        "m2hd")
            m2hd=true;;
        "archos5")
            archos5=true;;
        "nomedia")
            mhd=false
            m2hd=false
            archos5=false
            media=false;;
        "nopacsync")
            pacsync=false;;
        "noshare")
            pacsync=false
            share=false;;
        "notorrents")
            torrents=false;;
        "nowww")
            www=false;;
        "down")
            up=false;;
    esac
}

function emount ()
{
    rmdir /media/$1
    ln -s /share/eihort-media/$1 /media/$1
}

function eumount ()
{
    rm /media/$1
    mkdir /media/$1
    chmod 777 /media/$1
}

function emounted ()
{
    mount | grep -q //eihort/$1
}

function emedia ()
{
    file /media/$1 | grep -q /share/eihort-media/$1
}

function ecache ()
{
    file /var/cache/pacman/pkg | grep -q /share/eihort/pacman-cache
}

function packagecache ()
{
    ecache || /etc/cron.weekly/packagecache.sh 2>/dev/null

    [ "$1" = "on" ]  && rmdir /var/cache/pacman/pkg && ln -s /share/eihort/pacman-cache /var/cache/pacman/pkg
    [ "$1" = "off" ] && rm /var/cache/pacman/pkg    && mkdir /var/cache/pacman/pkg
}

for arg in "${*[@]}"; do
    parsearg $arg
done

mount | grep -q eihort
eihortcheck=$?

if $up && [[ $eihortcheck == 1 ]]; then
    $mhd      && emount MHD
    $m2hd     && emount M2HD
    $archos5  && emount ARCHOS5

    $share    && mount -t cifs -o username=share,password=share //eihort/share    /share/eihort
    $media    && mount -t cifs -o username=share,password=share //eihort/media    /share/eihort-media
    $torrents && mount -t cifs -o username=share,password=share //eihort/torrents /share/eihort-torrents
    $www      && mount -t cifs -o username=share,password=share //eihort/www      /share/eihort-www

    $pacsync  && packagecache on
else
    ecache            && packagecache off

    emounted share    && umount /share/eihort
    emounted media    && umount /share/eihort-media
    emounted torrents && umount /share/eihort-torrents
    emounted www      && umount /share/eihort-www

    emedia MHD        && eumount MHD
    emedia M2HD       && eumount M2HD
    emedia ARCHOS5    && eumount ARCHOS5
fi
