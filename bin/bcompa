#!/bin/zsh

function mount ()
{
    if [[ -e /dev/disk/by-label/$1 ]]; then
        $2 \
            && pmount /dev/disk/by-label/$1 \
            || sudo pumount /dev/disk/by-label/$1
        return 0
    fi
    return 1
}

function umount ()
{
    mount $1 false
}

function amount ()
{
    /bin/mount | grep MHD     || mount MHD
    /bin/mount | grep M2HD    || mount M2HD
    /bin/mount | grep ARCHOS5 || mount ARCHOS5
}

function wait-for-daemon ()
{
    while true; do
        if [[ -f /var/run/daemons/$1 ]]; then
            return true
        fi
    done
}

function if-server-exists ()
{
    ping -c1 $1 &>/dev/null
}

function network ()
{
    sudo netcfg-auto-wireless wlan0
}

function login ()
{
    urxvtd -q -f -o
    randombg

    if $1; then
        echo "Starting services"
        xscreensaver -no-splash &>/dev/null &
        ucron &>/dev/null &

        echo "BCompA commands"
        amount
        if-server-exists google.com || network
        if-server-exists eihort     && sudo eihort up
        mpddp

        echo "Starting programs"
        uzbl-browser &>/dev/null &
        claws-mail   &>/dev/null &
    else
        echo "Starting programs"
        urxvtc -e emacs &>/dev/null &
    fi
}

command=$1
shift
$command $*
