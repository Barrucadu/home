#!/bin/zsh

function mount ()
{
    if [[ -e /dev/disk/by-label/$1 ]]; then
        $2 \
            && pmount /dev/disk/by-label/$1 \
            || sudo pumount /dev/disk/by-label/$1
        return 0
    fi
    return 1
}

function umount ()
{
    mount $1 false
}

function amount ()
{
    mount MHD     false
    mount M2HD    false
    mount ARCHOS5 false

    mount MHD
    mount M2HD
    mount ARCHOS5
}

function wait-for-daemon ()
{
    while true; do
        if [[ -f /var/run/daemons/$1 ]]; then
            return true
        fi
    done
}

function if-server-exists ()
{
    ping -c1 $1 &>/dev/null
}

function network ()
{
    sudo netcfg-auto-wireless wlan0
}

function login ()
{
    urxvtd -q -f -o
    randombg

    if $1; then
        echo "Starting services"
        xscreensaver -no-splash &>/dev/null &
        ucron &>/dev/null &
        
        echo "BCompA commands"
        amount
        if-server-exists eihort || network
        if-server-exists eihort && sudo eihort up
        wait-for-daemon mpd     && mpddp

        echo "Starting programs"
        opera      &>/dev/null &
        claws-mail &>/dev/null &
    else
        echo "Starting programs"
        urxvtc -e emacs &>/dev/null &
    fi
}

command=$1
shift
$command $*
