#!/bin/zsh

# A part of the moviedb set of scripts - for adding new movies to the database.

chkdir()
{
    dir="$1"

    if [[ ! -d "$dir" ]]; then
	if [[ -e "$dir" ]]; then
	    echo " => $dir exists but is not a directory."
	    return 2
	else
	    mkdir "$dir"
	fi
    fi
}

help()
{
    echo "moviedb-add: A tool to add a movie to the filesystem database."
    echo
    echo "Usage: moviedb-add <file> [additional files] <director> <year> <genre1> <genre2> <genre3> ... <genren>"
    echo
    echo "Return codes:"
    echo "    1 = Movie file not found."
    echo "    2 = Error using director/genre directories."
}

if [[ "$1" == "" ]] || [[ "$1" == "--help" ]]; then
    help
    return 0
fi

movie="$1"    && shift
files=()


if [[ ! -e "$movie" ]]; then
    echo "$movie not found."
    return 1
fi

while [[ -f "$1" ]]; do
    files+=$1
    shift
done

director="$1" && shift
year="$1"     && shift
genres=()

while [[ "$1" != "" ]]; do
    genres+=$1
    shift
done

echo "Moving $movie to $MOVIEPATH/by-director/$director..."
chkdir "$MOVIEPATH/by-director/$director"
mv "$movie" "$MOVIEPATH/by-director/$director"

for file in $files; do
    echo "Moving $file to $MOVIEPATH/by-director/$director..."
    mv "$file" "$MOVIEPATH/by-director/$director"
done

echo "Adding movie to year $year..."
chkdir "$MOVIEPATH/by-year/$year"
ln -s "../../by-director/$director/$movie" "$MOVIEPATH/by-year/$year/$movie"

for file in $files; do
    ln -s "../../by-director/$director/$file" "$MOVIEPATH/by-year/$year/$file"
done

for genre in $genres; do
    echo "Adding movie to genre $genre..."
    
    chkdir "$MOVIEPATH/by-genre/$genre"
    out=$?
    if [[ $out != 0 ]]; then
        return $out
    fi
    
    ln -s "../../by-director/$director/$movie" "$MOVIEPATH/by-genre/$genre/$movie"

    for file in $files; do
        ln -s "../../by-director/$director/$file" "$MOVIEPATH/by-genre/$genre/$file"
    done
done

echo "Done."
