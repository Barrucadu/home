#!/bin/zsh

# A part of the moviedb set of scripts - for adding new movies to the database.

chkdir()
{
    dir="$1"

    if [[ ! -d "$dir" ]]; then
	if [[ -e "$dir" ]]; then
	    echo " => $dir exists but is not a directory."
	    return 2
	else
	    mkdir "$dir"
	fi
    fi
}

help()
{
    echo "moviedb-add: A tool to add a movie to the filesystem database."
    echo
    echo "Usage: moviedb-add <file> <director> <year> <genre1> <genre2> <genre3> ... <genren>"
    echo
    echo "Return codes:"
    echo "    1 = Movie file not found."
    echo "    2 = Error using director/genre directories."
    echo "    3 = Missing movie folder(s)."
}

if [[ "$1" == "" ]] || [[ "$1" == "--help" ]]; then
    help
    return 0
fi

movie="$1"    && shift
director="$1" && shift
year="$1"     && shift

if [[ -d $MOVIEPATH/by-director ]] && [[ -d $MOVIEPATH/by-genre ]]; then
    if [[ ! -e "$movie" ]]; then
	echo "$movie not found."
	return 1
    fi

    echo "Moving $movie to $MOVIEPATH/by-director/$director..."
    chkdir "$MOVIEPATH/by-director/$director"
    mv "$movie" "$MOVIEPATH/by-director/$director"

    echo "Adding movie to year $year..."
    chkdir "$MOVIEPATH/by-year/$year"
    ln -s "../../by-director/$director/$movie" "$MOVIEPATH/by-genre/$year/$movie"

    while [[ "$1" != "" ]]; do
	echo "Adding movie to genre $1..."

	chkdir "$MOVIEPATH/by-genre/$1"
        out=$?
        if [[ $out != 0 ]]; then
            return $out
        fi

	ln -s "../../by-director/$director/$movie" "$MOVIEPATH/by-genre/$1/$movie"
	shift
    done

    echo "Done."
else
    echo "\$MOVIEPATH = $MOVIEPATH"
    echo "\$MOVIEPATH/by-director or \$MOVIEPATH/by-genre does not appear to exist."
    return 3
fi
