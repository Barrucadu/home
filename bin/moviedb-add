#!/bin/zsh

# A part of the moviedb set of scripts - for adding new movies to the database.

MOVIEPATH=`[ "$MOVIEPATH" = "" ] && echo "/home/barrucadu/video/movies" || echo $MOVIEPATH`

chkdir()
{
    dir="$1"

    if [[ ! -d "$dir" ]]; then
	if [[ -e "$dir" ]]; then
	    echo " => $dir exists but is not a directory."
	    exit 2
	else
	    mkdir "$dir"
	fi
    fi
}

help()
{
    echo "moviedb-add: A tool to add a movie to the filesystem database."
    echo
    echo "Usage: moviedb-add <file> <director> <genre1> <genre2> <genre3> ... <genren>"
    echo
    echo "Return codes:"
    echo "    1 = Movie file not found."
    echo "    2 = Error using director/genre directories."
    echo "    3 = Missing movie folder(s)."
}

if [[ "$1" == "" ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    help
    exit 0
fi

movie="$1" && shift
director="$1" && shift

if [[ -d $MOVIEPATH/by-director ]] && [[ -d $MOVIEPATH/by-genre ]]; then
    if [[ ! -e "$movie" ]]; then
	echo "$movie not found."
	exit 1
    fi

    echo "Moving $movie to $MOVIEPATH/by-director/$director..."
    chkdir "$MOVIEPATH/by-director/$director"
    mv "$movie" "$MOVIEPATH/by-director/$director"

    while [[ "$1" != "" ]]; do
	echo "Adding movie to genre $1..."
	chkdir "$MOVIEPATH/by-genre/$1"
	ln -s "$MOVIEPATH/by-director/$director/$movie" "$MOVIEPATH/by-genre/$1/$movie"
	shift
    done

    echo "Done."
else
    echo "\$MOVIEPATH = $MOVIEPATH"
    echo "\$MOVIEPATH/by-director or \$MOVIEPATH/by-genre does not appear to exist."
    return 3
fi
