#!/bin/zsh

MOVIEPATH=`[ "$MOVIEPATH" = "" ] && echo "/home/barrucadu/movies" || echo $MOVIEPATH`

function args2str ()
{  
    string=$1
    while [[ $2 != "" ]]; do
        shift
        string="$string $1"
    done
    echo $string
}

function match ()
{
    grep $1 -m 1 -i $2
}

function moviematch ()
{
    string=$1

    prefix="^"
    suffix="\(, The\|\)\..*$"

    [ "$2" = "1" ] && prefix="" && suffix=""

    match "$prefix$string$suffix" $3
}

function director ()
{
    returncode=2

    for name in $MOVIEPATH/by-director/*; do
        ls $name | moviematch $1 $fuzzy -q && echo $name | sed "s/^.*\///" && returncode=0
    done
    
    return $returncode
}

function file ()
{
    name=`director $f "$1"`
    file=`ls "$MOVIEPATH/by-director/$name" | moviematch $movie $fuzzy`
    filepath="$MOVIEPATH/by-director/$name/$file"

    if [[ -f $filepath ]]; then
        [ $vlc = 0 ] && echo $filepath || vlc $filepath
    else
        return 2
    fi
}

function help ()
{
    echo "moviedb: A tool to query the filesystem movie database when the web database is unavailable."
    echo
    echo "Usage: moviedb <command> [-f] <arg1> <arg2> <arg3> ... <argn>"
    echo
    echo "Commands:"
    echo "    director      <movie>: Find the director of a movie."
    echo "    file     [-v] <movie>: Find the file path of a movie."
    echo "    genre         <movie>: Find the genres of a movie."
    echo
    echo "Arguments:"
    echo "    -f = fuzzy matching. Less accurate."
    echo "    -v = play in VLC. Must be specified after -f (if using fuzzy)."
    echo
    echo "Return codes:"
    echo "    1 = Unknown command."
    echo "    2 = Nonexistant movie."
    echo "    3 = Missing movie folder(s)."
    echo
    echo "Maintainer: Michael Walker"
}

if [[ -d $MOVIEPATH/by-director ]] && [[ -d $MOVIEPATH/by-genre ]]; then
    fuzzy=0
    vlc=0
    f=""

    [ "$1" != "" ]  && cmd=$1            && shift
    [ "$1" = "-f" ] && fuzzy=1 && f="-f" && shift
    [ "$1" = "-v" ] && vlc=1             && shift

    movie=`args2str $*`

    case $cmd in
        "director")
            director $movie;;
        "file")
            file $movie;;
        "genre")
            genre $movie;;
        "" | "help")
            help;;
        *)
            echo "Unknown command $cmd"
            return 1;;
    esac
else
    echo "\$MOVIEPATH = $MOVIEPATH"
    echo "\$MOVIEPATH/by-director or \$MOVIEPATH/by-genre does not appear to exist."
    return 3
fi
