#!/bin/zsh

MOVIEPATH=`[ "$MOVIEPATH" = "" ] && echo "/home/barrucadu/movies" || echo $MOVIEPATH`

function args2str ()
{  
    string=$1
    while [[ $2 != "" ]]; do
        shift
        string="$string $1"
    done
    echo $string
}

function match ()
{
    string=$1

    prefix="^"
    suffix="\(, The\|\)\..*$"

    [ "$2" = "1" ] && prefix="" && suffix=""

    grep "$prefix$string$suffix" -m 1 -i $3
}

function director ()
{
    returncode=2

    for name in $MOVIEPATH/by-director/*; do
        ls $name | match $1 $fuzzy -q && echo $name | sed "s/^.*\///" && returncode=0
    done
    
    return $returncode
}

function file ()
{
    name=`director $f "$1"`
    file=`ls "$MOVIEPATH/by-director/$name" | match $movie $fuzzy`
    filepath="$MOVIEPATH/by-director/$name/$file"

    if [[ -f $filepath ]]; then
        [ $vlc = 0 ] && echo $filepath || vlc $filepath
    else
        return 2
    fi
}

function genre ()
{
    returncode=2

    for name in $MOVIEPATH/by-genre/*; do
        ls $name | match $1 $fuzzy -q && echo $name | sed "s/^.*\///" && returncode=0
    done
    
    return $returncode
}

function list ()
{
    ls $MOVIEPATH/by-director/* | \
        sed "/^\(\s*\|.*\/.*\|.*\.\(srt\|idx\|sub\)\)$/d" | \
        sed "s/^\(.*\)\..*$/\\1/" | \
        sort | \
        $PAGER
}

function random ()
{
    if [[ "$1" != "" ]]; then
        genre=`ls $MOVIEPATH/by-genre/ | grep -i $1`
        ls $MOVIEPATH/by-genre/$genre | \
            shuf -n1 | \
            sed "s/^\(.*\)\..*$/\\1/"
    else
        list | \
            shuf -n1
    fi
}

function help ()
{
    echo "moviedb: A tool to query the filesystem movie database when the web database is unavailable."
    echo
    echo "Usage: moviedb <command> [-f] <arg1> <arg2> <arg3> ... <argn>"
    echo
    echo "Commands:"
    echo "    director      <movie>: Find the director of a movie."
    echo "    file     [-v] <movie>: Find the file path of a movie."
    echo "    genre         <movie>: Find the genres of a movie."
    echo "    list                 : List all movies."
    echo "    random        <genre>: Select a random movie of the (optional) specified genre."
    echo
    echo "Arguments:"
    echo "    -f = fuzzy matching. Less accurate."
    echo "    -v = play in VLC. Must be specified after -f (if using fuzzy)."
    echo
    echo "Return codes:"
    echo "    1 = Unknown command."
    echo "    2 = Nonexistant movie."
    echo "    3 = Missing movie folder(s)."
    echo
    echo "Maintainer: Michael Walker"
}

if [[ -d $MOVIEPATH/by-director ]] && [[ -d $MOVIEPATH/by-genre ]]; then
    fuzzy=0
    vlc=0
    f=""

    [ "$1" != "" ]  && cmd=$1            && shift
    [ "$1" = "-f" ] && fuzzy=1 && f="-f" && shift
    [ "$1" = "-v" ] && vlc=1             && shift

    args=`args2str $*`

    case $cmd in
        "director")
            director $args;;
        "file")
            file $args;;
        "genre")
            genre $args;;
        "list")
            list;;
        "random")
            random $args;;
        "" | "help")
            help;;
        *)
            echo "Unknown command $cmd"
            return 1;;
    esac
else
    echo "\$MOVIEPATH = $MOVIEPATH"
    echo "\$MOVIEPATH/by-director or \$MOVIEPATH/by-genre does not appear to exist."
    return 3
fi
