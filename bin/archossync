#!/bin/zsh

setopt extended_glob

archos=/media/ARCHOS5

function synchronise ()
{
    if [[ "$1" = "$archos/Pictures" ]]; then
        cp -urvn $1/^(Manga|Webcomics) $2
    elif [[ "$1" = "$archos/Video" ]]; then
        cp -urvn $1/^(anime|movies) $2
    else
        cp -urvn $1/* $2
    fi

    cp -urvn $2/* $1
}

[ "$1" = "verbose" ] && \
    alias -g :o='' || \
    alias -g :o='&>/dev/null' 

echo "Synchronising music..."
for artist in ~/music/all-files/*; do
    artistname=$(basename $artist)

    [ ! -d $archos/Music/$artistname/ ] && \
        cp -urv $artist $archos/Music/ :o
done

echo "\nSynchronising playlists..."
for file in ~/.data/mpd/playlists/*; do
    playlist=$archos/Playlists/$(basename $file)

    if [[ ! -f $playlist ]] || [[ $file -nt $playlist ]]; then
        echo $file :o
        cat $file | sed "s/home\/barrucadu\/music\/all-files/Music/" > $archos/Playlists/$(basename $file)
    fi
done

echo "\nRetrieving Downloads..."
mv $archos/Downloads/* ~/archos/Downloads :o

echo "\nSynchronising Flash videos..."
synchronise $archos/Flash ~/archos/Flash :o

echo "\nSynchronising PDFs..."
synchronise $archos/pdf ~/archos/PDF :o

echo "\nSynchronising Pictures..."
synchronise $archos/Pictures ~/archos/Pictures :o

echo "\nSynchronising Video..."
synchronise $archos/Video ~/archos/Video :o

echo "\nSynchronising Data..."
synchronise $archos/Data ~/archos/Data :o

echo "\nSynchronising Widgets..."
synchronise $archos/Widgets ~/archos/Widgets :o
