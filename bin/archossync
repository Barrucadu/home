#!/bin/zsh

setopt extended_glob

archos=/media/ARCHOS5

function syncfile ()
{
    file=$1
    from=$2
    to=$3

    file=$(basename $file $from)

    [ -d $from/$file ] && [ ! -d $to/$file ] && mkdir $to/$file -v
    [ -f $from/$file ] && [ ! -f $to/$file ] && cp $from/$file $to/$file -v
}

function copy ()
{
    from=$1
    to=$2
    ignorepattern=$3

    [ "$ignorepattern" = "" ] && ignorepattern="_arcthumb"

    find $from | grep -v -E $ignorepattern > /tmp/archos
    while read line; do
        syncfile $line $from $to
    done < /tmp/archos
    rm /tmp/archos
}

function synchronise ()
{
    one="$archos/$1"
    two="$HOME/archos/$2"

    [ "$two" = "$HOME/archos/" ] && \
        two="$HOME/archos/$1"

    if [[ "$1" = "Video" ]]; then
        copy $one $two "(anime|movies|_arcthumb)"
        copy $two $one "(anime|movies|_arcthumb)"
    else
        copy $one $two
        copy $two $one
    fi

    find ~/archos -iname "_arcthumb" | xargs -I file rm "file" -rv
}

[ "$1" = "verbose" ] && \
    alias -g :o='' || \
    alias -g :o='&>/dev/null' 

echo "Synchronising music..."
for artist in ~/music/all-files/*; do
    artistname=$(basename $artist)

    [ ! -d $archos/Music/$artistname/ ] && \
        cp -rvn $artist $archos/Music/ :o
done

echo "\nSynchronising playlists..."
for file in ~/.data/mpd/playlists/*; do
    playlist=$archos/Playlists/$(basename $file)

    if [[ ! -f $playlist ]] || [[ $file -nt $playlist ]]; then
        echo $file :o
        cat $file | sed "s/home\/barrucadu\/music\/all-files/Music/" > $archos/Playlists/$(basename $file)
    fi
done

echo "\nRetrieving Downloads..."
mv $archos/Downloads/* ~/archos/Downloads :o

echo "\nSynchronising Flash videos..."
synchronise Flash :o

echo "\nSynchronising PDFs..."
synchronise pdf PDF :o

echo "\nSynchronising Pictures..."
synchronise Pictures :o

echo "\nSynchronising Video..."
synchronise Video :o

echo "\nSynchronising Data..."
synchronise Data :o

echo "\nSynchronising Widgets..."
synchronise Widgets :o
