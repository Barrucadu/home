#!/usr/bin/env zsh

# With these two lines...
menufile="$XDG_DATA_HOME/menu/menu"
[[ "$1" = "" ]] || menufile=$1

dmenunf="`xrdb -query | grep '*color14:' | sed 's/.*#/#/'`"
dmenusf="`xrdb -query | grep '*color10:' | sed 's/.*#/#/'`"
dmenunb="`xrdb -query | grep '*color0:' | sed 's/.*#/#/'`"
dmenusb="`xrdb -query | grep '*color0:' | sed 's/.*#/#/'`"

categories="`sed "/^\( .*\|\)$/d" $menufile`"
category=`echo $categories | sed "s/ *\[.*//" | dmenu -nf $dmenunf -nb $dmenunb -sf $dmenusf -sb $dmenusb`
entries=""
parsing=false

if [[ ! "$category" == "" ]]; then
    while read line; do
	if echo "$categories" | grep -q "$line"; then
	    if [[ "$category" == "$line" ]]; then
		parsing=true
	    else
		parsing=false
	    fi
	else
	    if $parsing; then
		if [[ "$entries" == "" ]]; then
		    entries="$line"
		else
		    entries="$entries\n$line"
		fi
	    fi
	fi
    done < $menufile
    
    # ...and these four lines...
    if [[ "$entries" == "" ]]; then
	choice=$category
    else
	choice=`echo $entries | sed "s/ *\[.*//" | dmenu -nf $dmenunf -nb $dmenunb -sf $dmenusf -sb $dmenusb`
    fi
    # ...we have nested menu support :)

    [[ ! "$choice" == "" ]] && `grep "$choice *\[" $menufile | sed "s/.*\[\(.*\)\]/\\1/"` &>/dev/null &
fi