#!/bin/zsh

quietmode=0
failed=0

if [[ "$1" == "-q" ]] || [[ "$1" == "--quiet" ]];
then
    quietmode=1
    rm ~/tmp/uzbl/testoutput
fi

cd ~/uzbl

function stoptests ()
{
    if [[ $failed == 1 ]];
    then
        echo -ne "One or more tests failed. Run gdb (y/n): "
        read input
        
        if [[ "$input" == "y" ]];
        then
            gdb -ex run -ex backtrace ./uzbl
            exit
        fi
    fi
}

function runcmd ()
{
    output=0

    echo $*

    $* 2>&1
    output=$?
  
    echo
    
    return $output
}

function runtest ()
{
    echo -ne "Run test '$1' (y/n): "
    read input

    if [[ "$input" == "y" ]];
    then
        shift
        if [[ $quietmode == 0 ]];
        then
            runcmd $*
        else
            runcmd $* &>> ~/tmp/uzbl/testoutput
        fi
        
        if [[ $? == 0 ]];
        then
            echo "Test succeeded."
            echo ""
        else
            failed=1

            echo -ne "Test failed. Continue (y/n): "
            read input
            echo ""

            if [[ "$input" == "n" ]];
            then
                stoptests
            fi
        fi
    fi
}

runtest "test"             make test
runtest "test-config"      make test-config
runtest "test-config-real" make test-config-real
runtest "valgrind"         valgrind --tool=memcheck --leak-check=full --show-reachable=yes ./uzbl

stoptests
