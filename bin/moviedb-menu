#!/bin/zsh

MOVIEPATH=`[ "$MOVIEPATH" = "" ] && echo "/home/barrucadu/movies" || echo $MOVIEPATH`

dmenunf="`xrdb -query | grep '*color14:' | sed 's/.*#/#/'`"
dmenusf="`xrdb -query | grep '*color10:' | sed 's/.*#/#/'`"
dmenunb="`xrdb -query | grep '*color0:' | sed 's/.*#/#/'`"
dmenusb="`xrdb -query | grep '*color0:' | sed 's/.*#/#/'`"

function choice ()
{
    if $2; then
	echo $1 | dmenu -i -nf $dmenunf -nb $dmenunb -sf $dmenusf -sb $dmenusb -l 6
    else
	echo $1 | dmenu -i -nf $dmenunf -nb $dmenunb -sf $dmenusf -sb $dmenusb
    fi
}

function playfilm ()
{
    file=`moviedb file $1`
    director=`moviedb director $1`
    genres=`moviedb genre $1`
    
    message="Name: $1\nFile: $file\nDirector: $director\nGenre: $genres\n-\nPress enter to play."
    play=`choice $message true`
    
    if [[ "$play" != "" ]]; then
	moviedb play $1 &>/dev/null &
    fi
}

function choosefilm ()
{
    if [[ "$1" != "" ]]; then
	movies=""

	if [[ "$2" == "p" ]]; then
	    movies=`moviedb-lists list "$1" && echo "Random" && echo "Play All"`
	else
	    movies=`moviedb list $1 && echo "Random"`
	fi

	film=`choice $movies true`
	
	if [[ "$film" == "Random" ]]; then
	    playfilm "`moviedb random $1`"
	elif [[ "$film" == "Play All" ]] && [[ "$2" == "p" ]]; then
	    moviedb-lists play "$1" &>/dev/null &
	elif [[ "$film" != "" ]]; then
	    playfilm "$film"
	fi
    fi
}

function choosecategory ()
{
    choice `ls $MOVIEPATH/by-$1`
}

option=`choice "Director\nGenre\nPlaylist\nRandom" false`

case $option in
    "Director" | "Genre")
	category=`choosecategory $option:l`
	choosefilm $category
	;;

    "Playlist")
	list=`choice "\`moviedb-lists list\`"`
	choosefilm $list "p"
	;;

    "Random")
	playfilm "`moviedb random`"
	;;

    "")
	;;
esac