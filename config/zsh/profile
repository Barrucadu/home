## -*- shell-script -*-

##### Colours

# Framebuffer zenburn colours
if [ "$TERM" = "linux" ]; then
    echo -en "\e]P01C1C20"
    echo -en "\e]P84d4d4d"
    echo -en "\e]P1CE5C00"
    echo -en "\e]P9F57900"
    echo -en "\e]P2B7CE42"
    echo -en "\e]PABDE077"
    echo -en "\e]P3B88B10"
    echo -en "\e]PBFFC135"
    echo -en "\e]P466AABB"
    echo -en "\e]PCAACCBB"
    echo -en "\e]P5B7416E"
    echo -en "\e]PDBB4466"
    echo -en "\e]P65E7175"
    echo -en "\e]PEA3BABF"
    echo -en "\e]P7D6D8D9"
    echo -en "\e]PF6C887A"
    clear
fi

# Terminal colours
autoload colors zsh/terminfo
if [[ "$terminfo[colors]" -ge 8 ]]; then
	colors
fi

for color in RED GREEN YELLOW BLUE MAGENTA CYAN WHITE; do
	eval PR_$color='%{$terminfo[bold]$fg[${(L)color}]%}'
	eval PR_LIGHT_$color='%{$fg[${(L)color}]%}'

	export PR_$color
	export PR_LIGHT_$color
done

export PR_NO_COLOR="%{$terminfo[sgr0]%}"

##### Environment
export PATH="/usr/local/bin:/usr/local/sbin:/home/barrucadu/bin:/home/barrucadu/.cabal/bin:/home/barrucadu/.gem/ruby/2.0.0/bin:/home/barrucadu/.local/bin:$PATH:/usr/share/java/apache-ant/bin"

export BROWSER=chromium
export EDITOR=vim
export VISUAL=$EDITOR

export LANG=en_GB.UTF-8
export LC_ALL=en_GB.UTF-8
export LC_CTYPE=en_GB.UTF-8

##### History
export HISTFILE=${XDG_DATA_HOME:-~/.local/share}/zsh/history
export HISTSIZE=1000
export SAVEHIST=1000
export DIRSTACKSIZE=16

setopt hist_ignore_dups
setopt hist_no_functions
setopt hist_reduce_blanks
setopt hist_verify
setopt share_history


# Compilation
export CFLAGS="-Wall -Wextra -Wcast-align -Wconversion -Winit-self -Winline -Wmissing-declarations -Wmissing-prototypes -Wnested-externs -Wno-long-long -Wpointer-arith -Wredundant-decls -Wshadow -Wstrict-prototypes -Wwrite-strings -pedantic -O2"
export CPPFLAGS=$CFLAGS
export CXXFLAGS=$CFLAGS

##### Prompt

# prompt
function prompt_git_dirty() {
    gitstat=$(git status 2>/dev/null | grep '\(# Untracked\|# Changes\|# Changed but not updated:\)')
    
    if [[ $(echo ${gitstat} | grep -c "^# Changes to be committed:$") > 0 ]]; then
        echo -n $PR_LIGHT_YELLOW
    elif [[ $(echo ${gitstat} | grep -c "^\(# Untracked files:\|# Changed but not updated:\)$") > 0 ]]; then
        echo -n $PR_LIGHT_RED
    else
        echo -n $PR_LIGHT_MAGENTA
    fi
}

function prompt_current_branch() {
    ref=$(git symbolic-ref HEAD 2> /dev/null) || return 1
    echo ${ref#refs/heads/}
}

function prompt_hostname()
{
    host=`hostname`
    colour="PR_`grep \"^$host\" ~/.zsh/host_colours | sed 's/.*:\s*//' | tr '[:lower:] ' '[:upper:]_'`"
    echo -n "${(P)colour:-$PR_LIGHT_RED}${host}${PR_NO_COLOR}"
}

function precmd() # Uses: setting user/root PROMPT1 variable and rehashing commands list
{
    # Last command status
    cmdstatus=$?
    sadface=`[ "$cmdstatus" != "0" ] && echo "${PR_RED}:(${PR_NO_COLOR} "`

    # Colours
    usercolour=`[ $UID != 0 ]   && echo $PR_GREEN      || echo $PR_RED`
    usercolour2=`[ $UID != 0 ]  && echo $PR_LIGHT_BLUE || echo $PR_RED`
    dircolour=`[ -w "\`pwd\`" ] && echo $PR_CYAN       || echo $PR_RED`

    # Git branch
    git="[branch: `prompt_git_dirty``prompt_current_branch`${PR_NO_COLOR}]"

    export PS1="
${usercolour}%n${PR_NO_COLOR} on `prompt_hostname` in ${dircolour}%~${PR_NO_COLOR} `prompt_current_branch &>/dev/null && echo -n $git`
 ${sadface}${usercolour2}>>>${PR_NO_COLOR}  "
}

export PS2="$PR_BLUE%B%_%b >$PR_NO_COLOR "
export PS3="$PR_YELLOW%Bselect%b:$PR_NO_COLOR "

##### Emacs shell mode
[[ $EMACS = t ]] && unsetopt zle

##### Keybindings
bindkey "\e[1~"  beginning-of-line
bindkey "\e[4~"  end-of-line
bindkey "\e[5~"  beginning-of-history
bindkey "\e[6~"  end-of-history
bindkey "\e[3~"  delete-char
bindkey "\e[2~"  quoted-insert
bindkey "\e[5C"  forward-word
bindkey "\eOc"   emacs-forward-word
bindkey "\e[5D"  backward-word
bindkey "\eOd"   emacs-backward-word
bindkey "\e\e[C" forward-word
bindkey "\e\e[D" backward-word
bindkey "^H"     backward-delete-word
bindkey "\e[8~"  end-of-line
bindkey "\e[7~"  beginning-of-line
bindkey "\eOH"   beginning-of-line
bindkey "\eOF"   end-of-line
bindkey "\e[H"   beginning-of-line
bindkey "\e[F"   end-of-line
bindkey '^i'     expand-or-complete-prefix

##### Colourful directory listings
eval `dircolors -b`

##### Tab completion
zle -C complete-file complete-word _generic

zstyle ':completion:*'                 completer _complete _match _approximate
zstyle ':completion:*:match:*'         original only
zstyle ':completion:*:approximate:*'   max-errors 1 numeric
zstyle ':completion:*:*'               original only
zstyle ':completion:complete-file::::' completer _files
zstyle ':completion:*'                 completer _complete _ignored _files

autoload -Uz compinit
compinit

setopt menu_complete
setopt hash_list_all

##### Directory navigation
setopt auto_cd
setopt auto_pushd
setopt pushd_silent
setopt pushd_to_home
setopt chase_links

##### Globbing
setopt extended_glob
setopt glob_dots
setopt mark_dirs
setopt multibyte
setopt null_glob

##### Misc
setopt interactive_comments
setopt correct
