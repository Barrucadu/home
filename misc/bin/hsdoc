#!/bin/bash

hsfiles=$(cabal-info exposed-modules | sed -e 's:\.:/:g' -e 's:$:.hs:')
otherfiles=$(cabal-info other-modules | sed -e 's:\.:/:g' -e 's:$:.hs:')

name=$(cabal-info name)
version=$(cabal-info version)
synopsis=$(cabal-info synopsis)

dir=${1:-"docs"}
url=${2:-"http://barrucadu.github.io/$name"}
css=${3:-"tango"}

stack="$HOME/.local/bin/stack"
hscolour="$HOME/.local/bin/HsColour"
cpphs="$HOME/.local/bin/cpphs"
haddock="$HOME/.local/bin/haddock"

tmpdir=`mktemp -d`

# Highlight source

mkdir -p $dir/source

wget "https://raw.githubusercontent.com/houshuang/hackage-css/master/generated_css/$css.css" -O "$dir/source/hscolour.css"

for file in $hsfiles; do
  $hscolour "$file" -css -anchor \
    -o"$dir/source/`echo $file | sed 's:^\./\(.*\)\.hs$:\1:' | sed 's:/:-:g'`.html"
done

# Generate documentation

cabal-info description > "$tmpdir/description"

macros=$(find . -type f -wholename "./.stack-work/*/autogen/cabal_macros.h")

for file in $hsfiles; do
  mkdir -p "$tmpdir/`dirname $file`"
  efile="$tmpdir/`dirname $file`/`basename $file`"
  $cpphs "$file" -O"$efile" \
    --include="$macros" \
    --strip --strip-eol
done

for file in $otherfiles; do
  mkdir -p "$tmpdir/`dirname $file`"
  efile="$tmpdir/`dirname $file`/`basename $file`"
  $cpphs "$file" -O"$efile" \
    --include="$macros" \
    --strip --strip-eol
done

processedfiles=$(find "$tmpdir" -type f -name '*.hs')
hidefiles=$(cabal-info other-modules | sed 's:^:--hide=:' | tr '\n' ' ')

$stack exec -- \
  $haddock $processedfiles -o "$dir" \
    --title="$name-$version: $synopsis" \
    --prologue="$tmpdir/description" \
    --html --built-in-themes \
    --source-module="$url/source/%{MODULE/./-}.html" \
    --source-entity="$url/source/%{MODULE/./-}.html#%N" \
    --source-entity-line="$url/source/%{MODULE/./-}.html#line-%L" \
    $hidefiles

# Clean up

rm -rf $tmpdir
