#!/usr/bin/env bash

# constants
NIX_ENV_DIR=$HOME/.nixpkgs/environments
GC_ROOT_DIR=$NIX_ENV_DIR/.gcroots

# arguments
env=$1

# sanity check to avoid confusion
if [[ "$NIX_PERSISTENT_ENV" != "" ]]; then
  echo "shells should be nested with care, unset \$NIX_PERSISTENT_ENV to force" >&2
  exit 1
fi

function nix_shell {
  local tag=$1
  local nixfile=$2
  local gcrootdir=$3

  nix-shell "$nixfile" --indirect --add-root "$gcrootdir/gc" --command "NIX_PERSISTENT_ENV=$tag PROMPT_TAG=$tag zsh"
}

# launch environment
if [[ -z "$env" ]]; then
  if [[ -e shell.nix ]]; then
    nix_shell "`basename $(pwd)`" shell.nix .gcroots
  else
    echo "no environment given and no shell.nix in the current directory" >&2
    exit 1
  fi
elif [[ -e "$NIX_ENV_DIR/$env.nix" ]]; then
  nix_shell "$env" "$NIX_ENV_DIR/$env.nix" "$GC_ROOT_DIR/$env"
else
  echo "could not find $env.nix in $NIX_ENV_DIR" >&2
  exit 1
fi
