## -*- shell-script -*-

# Display information about the state of the world.
function status(){
  clear

  # Display a fortune
  if has fortune; then
    fortune | sed "s:^:>  :"
  fi

  # The top 10 most urgent tasks
  task next limit:10

  # This month's budget
  echo "\n$(date +%B) Budget:"
  if $IS_GNULINUX; then
    local nextm=`date --date=+1month +"%Y-%m-01"`
  else
    local nextm=`date -v+1m +"%Y-%m-01"`
  fi
  hledger balance -N -B -H --end=$nextm --tree budget | sed -e 1d -e 2d -e 3d -e 4d | sed 's:^            ::' | sed 's:          :  :'

  echo
}

# Run and disown a program
function r()
{
    $* &>/dev/null &
    disown %%
}

# Run and disown a program, then terminate the shell
function re()
{
    $* &>/dev/null &
    disown %%
    exit
}

# Run a program with the grp environment
function grprun() {
    local GRPDIR=${GRPDIR:-/tmp/hacksoc-grp}

    PATH=$GRPDIR/bin:$PATH \
    LD_LIBRARY_PATH=$GRPDIR/lib:$LD_LIBRARY_PATH \
    PYTHONPATH=$GRPDIR/lib/python3.3/site-packages:$PYTHONPATH \
    $*
}

# List a directory, restricting by some regex, and tabulate the result.
function lsby() {
    local regex=$1
    shift
    ls $* | grep $regex | column -c `tput cols`
}

# Short alias for stack, with abbreviated subcommands.
function s() {
  local command=$1

  typeset -A subcommands
  local subcommands=(b build c clean e exec eg "exec ghci" g ghci i install r runghc t test)

  if [[ $command == "-h" ]] || [[ $command == "--help" ]]; then
    echo "Usage: s <command or alias> <args>"
    echo "Shorthand for 'stack'\n"
    echo "Aliases:"
    for k in "${(@ko)subcommands}"; do
      echo "    ${(r:2:: :)${k}} -> $subcommands[$k]"
    done
    echo "\nFor stack help, see 'stack --help' (or just 's')"
  else
    shift 2>/dev/null
    stack ${=subcommands[$command]:-$command} $*
  fi
}

### Predicates

# Check if a command exists, can be a binary in PATH or a shell
# alias/function.
function has() {
  type $1 &>/dev/null
}

# Check if a string is a hostname we can ssh into.
function is_host() {
  grep "^Host $1$" ~/.ssh/config &>/dev/null || grep " $1\b" /etc/hosts &>/dev/null
}

# Check if a host supports mosh connections.
function use_mosh() {
  grep "^$1$" ~/.ssh/use_mosh &>/dev/null
}

### Smarter versions of regular commands

# A smarter `mosh`/`ssh`: connects using `mosh` if installed and the
# target supports it (see ~/.ssh/use_mosh)
function smartmosh() {
  if use_mosh $1 && has mosh; then
    mosh $1
  else
    ssh $1
  fi
}

### I can never remember the argument order for ssh stuff.

# Forward a port on a remote machine to the same local port.
function sshfwd() {
  ssh -NL $2:localhost:$2 $1
}

# Set up a SOCKS proxy to a remote machine.
function knit() {
  ssh -ND $2 $1
}

### Prompt tag


# Set the prompt tag.
function ptag(){
  PROMPT_TAG=$1
}

# Unset the prompt tag.
function puntag(){
  PROMPT_TAG=""
}

# Push to the prompt tag
function ptag_push(){
  if [[ -z $PROMPT_TAG ]]; then
    PROMPT_TAG=$1
  else
    PROMPT_TAG=$PROMPT_TAG/$1
  fi
}

# Pop from the prompt tag.
function ptag_pop(){
  PROMPT_TAG=`dirname $PROMPT_TAG`
  if [[ "$PROMPT_TAG" == "." ]]; then
    PROMPT_TAG=""
  fi
}
