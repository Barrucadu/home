## -*- shell-script -*-

##### Colours

# Framebuffer zenburn colours
if [ "$TERM" = "linux" ]; then
    echo -en "\e]P01C1C20"
    echo -en "\e]P84d4d4d"
    echo -en "\e]P1CE5C00"
    echo -en "\e]P9F57900"
    echo -en "\e]P2B7CE42"
    echo -en "\e]PABDE077"
    echo -en "\e]P3B88B10"
    echo -en "\e]PBFFC135"
    echo -en "\e]P466AABB"
    echo -en "\e]PCAACCBB"
    echo -en "\e]P5B7416E"
    echo -en "\e]PDBB4466"
    echo -en "\e]P65E7175"
    echo -en "\e]PEA3BABF"
    echo -en "\e]P7D6D8D9"
    echo -en "\e]PF6C887A"
    clear
fi

# Terminal colours
autoload colors zsh/terminfo
colors

colnames=(black red green yellow blue magenta cyan white default)
for color in $colnames; do
	eval f$color='%{$fg[${color}]%}'
	eval fb$color='%{$terminfo[bold]$fg[${color}]%}'
	eval b$color='%{$bg[${color}]%}'
done

foregrounds=($fblack $fred $fgreen $fyellow $fblue $fmagenta $fcyan $fwhite $fdefault
             $fbblack $fbred $fbgreen $fbyellow $fbblue $fbmagenta $fbcyan $fbwhite $fbdefault)
backgrounds=($bblack $bred $bgreen $byellow $bblue $bmagenta $bcyan $bwhite $bdefault)

##### History
export HISTFILE=${XDG_DATA_HOME:-~/.local/share}/zsh/history
export HISTSIZE=1000
export SAVEHIST=1000
export DIRSTACKSIZE=16

setopt hist_ignore_dups
setopt hist_no_functions
setopt hist_reduce_blanks
setopt hist_verify
setopt share_history

##### Prompt

# prompt
function prompt_git_dirty() {
    local gitstat=$(git status 2>/dev/null | grep '\(# Untracked\|# Changes\|# Changed but not updated:\)')
    
    if [[ $(echo ${gitstat} | grep -c "^# Changes to be committed:$") > 0 ]]; then
        echo -n $fyellow
    elif [[ $(echo ${gitstat} | grep -c "^\(# Untracked files:\|# Changed but not updated:\)$") > 0 ]]; then
        echo -n $fred
    else
        echo -n $fmagenta
    fi
}

function prompt_current_branch() {
    ref=$(git symbolic-ref HEAD 2> /dev/null) || return 1
    echo ${ref#refs/heads/}
}

function _prompt_hostname_colour()
{
    local chash=0
    for letter in $HOST; do
        ((chash += #letter))
    done

    echo $foregrounds[$(( $chash % $#foregrounds ))]
}

hostname_colour=$(_prompt_hostname_colour)

function precmd() # Uses: setting user/root PROMPT1 variable and rehashing commands list
{
    # Last command status
    cmdstatus=$?
    sadface=`[ "$cmdstatus" != "0" ] && echo "${fred}:(${fdefault} "`

    # Colours
    usercolour=`[ $UID != 0 ]   && echo $fbgreen || echo $fred`
    usercolour2=`[ $UID != 0 ]  && echo $fblue   || echo $fred`
    dircolour=`[ -w "\`pwd\`" ] && echo $fbcyan  || echo $fred`

    # Git branch
    git="[branch: `prompt_git_dirty``prompt_current_branch`${fdefault}] "

    # Hostname
    prompt_hostname="${hostname_colour}${HOST}${fdefault}"

    export PS1="${usercolour}%n${fdefault} on ${prompt_hostname} `prompt_current_branch &>/dev/null && echo -n $git`${sadface}${usercolour2}>>>${fdefault}  "
    export RPROMPT="${dircolour}%~${fdefault}"
}

export PS2="${fblue}%B%_%b >${fdefault} "
export PS3="${fyellow}%Bselect%b:${fdefault} "

##### Keybindings
bindkey "\e[1~"  beginning-of-line
bindkey "\e[4~"  end-of-line
bindkey "\e[5~"  beginning-of-history
bindkey "\e[6~"  end-of-history
bindkey "\e[3~"  delete-char
bindkey "\e[2~"  quoted-insert
bindkey "\e[5C"  forward-word
bindkey "\eOc"   emacs-forward-word
bindkey "\e[5D"  backward-word
bindkey "\eOd"   emacs-backward-word
bindkey "\e\e[C" forward-word
bindkey "\e\e[D" backward-word
bindkey "^H"     backward-delete-word
bindkey "\e[8~"  end-of-line
bindkey "\e[7~"  beginning-of-line
bindkey "\eOH"   beginning-of-line
bindkey "\eOF"   end-of-line
bindkey "\e[H"   beginning-of-line
bindkey "\e[F"   end-of-line
bindkey '^i'     expand-or-complete-prefix

##### Colourful directory listings
eval `dircolors -b`

##### Tab completion
zle -C complete-file complete-word _generic

zstyle ':completion:*'                 completer _complete _match _approximate
zstyle ':completion:*:match:*'         original only
zstyle ':completion:*:approximate:*'   max-errors 1 numeric
zstyle ':completion:*:*'               original only
zstyle ':completion:complete-file::::' completer _files
zstyle ':completion:*'                 completer _complete _ignored _files

autoload -Uz compinit
compinit

setopt menu_complete
setopt hash_list_all

##### Directory navigation
setopt auto_cd
setopt auto_pushd
setopt pushd_silent
setopt pushd_to_home
setopt chase_links

##### Globbing
setopt extended_glob
setopt glob_dots
setopt mark_dirs
setopt multibyte
setopt null_glob

##### Misc
setopt interactive_comments
setopt correct
